@using ABCRetailers.Models
@model IEnumerable<ABCRetailers.Models.Order>
@{
    ViewData["Title"] = "Orders";
}

<div class="card shadow border-0">
    <div class="card-header bg-dark text-white py-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3 class="h5 mb-1 fw-normal">Orders</h3>
                <p class="mb-0 opacity-75 small">Manage customer orders</p>
            </div>
            <a asp-action="Create" class="btn btn-light btn-sm">
                Add Order
            </a>
        </div>
    </div>

    <div class="card-body">
        @if (Model != null && Model.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Product</th>
                            <th>Order Date</th>
                            <th>Qty</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in Model.OrderByDescending(o => o.OrderDateUtc))
                        {
                            <tr>
                                <td><code class="text-dark">@(order.Id?.Length > 8 ? order.Id[..8] + "…" : order.Id)</code></td>
                                <td class="text-dark">@order.CustomerId</td>
                                <td class="text-dark">@(!string.IsNullOrWhiteSpace(order.ProductName) ? order.ProductName : order.ProductId)</td>
                                <td class="text-dark">@FormatLocal(order.OrderDateUtc)</td>
                                <td class="text-dark">@order.Quantity</td>
                                <td class="fw-bold text-dark">@order.TotalAmount.ToString("C")</td>
                                <td><span class="badge bg-@Badge(order.Status)">@order.Status</span></td>
                                <td class="text-center">
                                    <div class="btn-group">
                                        <a asp-action="Details" asp-route-id="@order.Id" class="btn btn-sm btn-outline-dark" title="Details">
                                            View
                                        </a>
                                        <a asp-action="Edit" asp-route-id="@order.Id" class="btn btn-sm btn-outline-dark" title="Edit">
                                            Edit
                                        </a>

                                        @if (order.Status is not OrderStatus.Completed and not OrderStatus.Cancelled)
                                        {
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown" title="Update Status">
                                                    Status
                                                </button>
                                                <ul class="dropdown-menu">
                                                    @if (order.Status == OrderStatus.Submitted)
                                                    {
                                                        <li>
                                                            <a class="dropdown-item" href="#" onclick="updateOrderStatus('@order.Id','Processing')">
                                                                Mark as Processing
                                                            </a>
                                                        </li>
                                                    }
                                                    @if (order.Status == OrderStatus.Processing)
                                                    {
                                                        <li>
                                                            <a class="dropdown-item" href="#" onclick="updateOrderStatus('@order.Id','Completed')">
                                                                Mark as Completed
                                                            </a>
                                                        </li>
                                                    }
                                                    <li>
                                                        <a class="dropdown-item" href="#" onclick="updateOrderStatus('@order.Id','Cancelled')">
                                                            Cancel Order
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        }

                                        <button type="button" class="btn btn-sm btn-outline-dark" onclick="confirmDelete('@order.Id','@order.Id')" title="Delete">
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-secondary border-0">
                No orders found.
                <a asp-action="Create" class="alert-link text-dark">Create your first order</a>
            </div>
        }
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete order <strong id="orderId"></strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-dark">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

@functions {
    string FormatLocal(DateTimeOffset? dto)
        => dto.HasValue ? dto.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm") : "-";

    string Badge(OrderStatus status) => status switch
    {
        OrderStatus.Submitted => "secondary",
        OrderStatus.Processing => "dark",
        OrderStatus.Completed => "success",
        OrderStatus.Cancelled => "danger",
        _ => "secondary"
    };
}

<!-- hidden antiforgery token for AJAX -->
<form id="__af" method="post" style="display:none">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        function confirmDelete(orderIdFull, orderIdForDisplay) {
            const shortId = (orderIdForDisplay && orderIdForDisplay.length > 8) ? orderIdForDisplay.substring(0,8) + '…' : orderIdForDisplay;
            document.getElementById('orderId').textContent = shortId;
            document.getElementById('deleteForm').action = '@Url.Action("Delete", "Order")/' + encodeURIComponent(orderIdFull);
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        function updateOrderStatus(orderId, newStatus) {
            if (!confirm(`Are you sure you want to change the status to "${newStatus}"?`)) return;

            const token = document.querySelector('#__af input[name="__RequestVerificationToken"]').value;
            const body  = new URLSearchParams({ id: orderId, newStatus: newStatus, __RequestVerificationToken: token });

            fetch('@Url.Action("UpdateOrderStatus", "Order")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
                body
            })
            .then(r => r.json())
            .then(data => {
                if (data && data.success) location.reload();
                else alert('Error: ' + (data && data.message ? data.message : 'Unknown error'));
            })
            .catch(() => alert('An error occurred while updating the status'));
        }
    </script>
}